# DEFT2013 Tâche 2 : CheffoBerto

CHARLOT Théo - SEWRAJ Hreshvik

## Description de la tâche

	recette_8333.xml : 
 		-titre : Terrine de Carrés Frais aux poires
   		-recette : "Ecraser les Carrés Frais, le roquefort et le mascarpone. Ajouter le poivre et les cerneaux de noix. Faire tremper les feuilles de gélatine dans de l'eau froide. Faire chauffer la crème. Essorer les feuilles de gélatine et les faire fondre dans la crème. Eplucher les poires, les trancher, et les citronner. Dans une petite terrine (style beurrier), mettre une couche de poires, une couche de fromage, etc... Terminer par le fromage (en démoulant, les poires doivent se trouvées sur le dessus). Mettre au frais 2 h. Et servir en tranches, sur du pain grillé."
		-ingredients : - 6 gros Carrés Frais - 3 portions individuelles de roquefort - 1/2 pot de mascarpone - 2 feuilles de gélatine  - poivre - 1 cuillère à soupe de crème fraîche - quelques cerneaux de noix - 2 poires - le jus d'1 citron,
	recette_217223.xml:
 		-titre : Cappelletti à la sauce tomate
   		-Ingredients : "- 1 gros œuf - 1 cuillère à soupe d’huile - 1 cuillère à soupe de lait - 1 tasse de farine - 1 pincée de sel - farine (pour rouler la pâte) - 250 g de mozzarella - 12 tomates - 1 gros oignon (ou échalote) - 4 feuilles de laurier - 1 gousse d’ail  - quelques feuilles de basilic - sel, poivre - 2 cuillères à soupe d’huile - 1 cuillère à soupe de cassonade"
		-Recette : "Matériel: 1 rouleau à pâtisserie 1 emporte-pièce de taille moyenne (environ 5 à 6 cm de diamètre) 1 tasse d’eau pour le montage 1 saladier Préparation de la pâte à pâtes : Mélangez dans un saladier ou un cul-de-poule l’œuf, l’huile, le lait et le sel. Mélangez bien (avec les doigts et les mains). Ajoutez la farine, mélangez bien. La pâte ne doit être ni dure (sèche), ni molle (collante). Si elle est trop dure, ajoutez un peu de lait petit à petit, si elle est trop molle, ajoutez un peu de farine petit à petit. Lorsque votre pâte a une bonne consistance, faites-en une boule, puis divisez-la en cinq petites boules. Laissez reposer une bonne heure les cinq boules sur votre plan de travail et sous une cloche en plastique (un saladier fera l’affaire).Pendant ce temps, si vous avez plusieurs boules de mozzarella, les réunir en une grosse boule (la malaxer pour former la boule. Si la boule de mozzarella a du mal à se former, vous pouvez toujours la râper et former la boule ensuite), et vous pouvez également préparer la sauce tomate. Préparation de la sauce tomate: Coupez finement l’ail et l’oignon (ou les échalotes). Lavez et coupez 6 tomates en dés. Lavez, coupez en quartiers et mixez les 6 autres tomates. Dans une casserole, faites dorer les oignons (ou les échalotes) avec l’ail et l'huile d'olive. Puis, ajoutez les dés de tomates et les feuilles de laurier. Laissez cuire un peu jusqu’à ce que le mélange soit rouge orangé, et que les tomates soient un peu réduites en bouillie avec la chaleur de la casserole. Puis, tamisez la purée de tomate au-dessus de la casserole. Salez, poivrez, puis ajoutez le sucre. Mélangez. Ajoutez sur le dessus le basilic pour parfumer. Couvrez et laissez cuire à feu doux pendant une quinzaine de minutes. Formation des cappelletti (environ une 50aine): Lorsque la pâte a bien reposé, prenez une boule, farinez un peu votre plan de travail et votre rouleau à pâtisserie, puis étalez la pâte en essayant de former un rond (plus ou moins). Il faut que la pâte soit bien fine. Si vous faites des trous dans votre pâte (ce qui peut arriver, car elle est assez fragile), laissez les trous, vous ne pouvez pas reformer la pâte en boule pour l'étaler de nouveau. Donc laissez les trous, et vous éviterez de couper des ronds avec des trous. Une fois la pâte prête et bien étalée, à l’aide de votre emporte-pièce, coupez des ronds. Puis prenez les ronds dans vos mains, trempez votre index dans l’eau (la tasse d'eau) et mouillez les extrémités du rond (faites le tour du rond avec votre doigt mouillé d’eau). Ensuite, prenez une petite boule de mozzarella, puis mettez-la au centre du rond. Fermez le rond en faisant une légère pression sur les bords du rond. Vous devriez avoir une sorte d’empanada. Ensuite, à l’aide de votre index, mouillez les pointes de l’empanada. Prenez-le en face de vous (les extrémités derrière la boule qui est face à vous). Prenez l’extrémité droite, puis la mettre sous l’extrémité gauche, au centre de l’empanada, derrière la boule. Appuyez bien pour coller les deux extrémités, puis faire un petit ourlet en rabattant les extrémités vers le haut. Devant la boule, vous devriez obtenir un petit ourlet, que vous allez remettre droit. Donc au final du montage, vous devez avoir comme un chapeau, avec une boule au milieu, un petit ourlet derrière, et devant comme le devant d’une casquette, une espèce de visière on peut dire. Procédez de même pour les autres ronds afin de former le reste des cappelletis. Ensuite, saupoudrez-les d’un peu de farine. Si jamais la pâte se casse un peu quand vous formez les cappelletis, ce n'est pas grave. Ensuite, vous avez deux choix : soit vous les congelez pour les cuire plus tard (les pâtes se congèlent très bien si vous les recouvrez de film alimentaire), soit vous les cuisez maintenant. Sachez que le temps de cuisson est le même que les pâtes soient congelées ou non. Cuisson : Dans une casserole, faites bouillir de l’eau à laquelle vous aurez ajouté une pincée de sel. Lorsque l’eau est portée à ébullition, mettre les pâtes, puis compter 3 minutes de cuisson. Pendant ce temps, réchauffez un peu la sauce dans la casserole si elle s’est refroidie. Servez la sauce dans un plat (avec ou non les feuilles de laurier selon votre choix). Lorsque les pâtes sont cuites, égouttez-les et versez-les ensuite dans la sauce. C’est normal que les pâtes baignent dans la sauce, cela leur donne un très bon goût !Servez et dégustez !La recette va peut-être vous paraître longue et difficile à réaliser, mais c'est en fait une recette très simple ! La seule difficulté peut-être est la réalisation des cappelletti. Mais essayez la recette, cela vaut vraiment le coup de manger des pâtes délicieuses faites maison ! En plus, vous pouvez les congeler, et le temps de cuisson n'est que de trois minutes !Bon appétit !"


## Statistiques corpus

	train : 9977
 	dev : 2496
  	test : 1388
	Répartition des étiquettes dans chacun des sous-ensemble
 	train : 
  		-Entrée : 2327
		-Plat principal : 4641 
		-Dessert : 3009
	dev : 
 		-Entrée : 582
		-Plat principal : 1161 
		-Dessert : 753
	test:
  		-Entrée : 337
		-Plat principal : 644 
		-Dessert : 407

## Méthodes proposées
	Pour les méthodes suivantes sont utilisés : 
	-Descripteur :
 		-Recette
   	-Classifieur :
		-Type
      
### Run1: baseline (méthode de référence)

	Description de la méthode:
 		Classe majoritaire

### Run2: Word2Vec + MLP  
	Word2Vec avec une couche MLP pour la classification

### --- TF-IDF avec et sans normalisation ---
### Run3: TF-IDF Random-Forest 
	TF-IDF avec classifieur Random-Forest
### Run4: TF-IDF KNN 
	TF-IDF avec classifieur KNN
### Run5: TF-IDF Random-Forest + SMOTE
	Ajout de la méthode SMOTE: Synthetic Minority Oversampling TEchnique
### Run6: TF-IDF KNN Classifier + SMOTE
	Ajout de la méthode SMOTE: Synthetic Minority Oversampling TEchnique
### --- Architectures BERT ---
### Run7: distilbert-finetuné
	Distilbert finetuné pendant 3120 steps
### Run8: distilbert-finetuné-ingredients
	-Descripteurs : 
 		-Ingredients
	Distilbert finetuné pendant 3744 steps
 ### Run10: camembert-finetuné
	Camembert finetuné pendant 1248 steps
 ### Run11: camembert-finetuné-naive-weighted
	Camembert finetuné pendant 1900 steps avec modification des poids dans la loss function de l'apprentissage correspondant à la répartition des classes
| Entrée      | Plat principal | Dessert |
| -------- | -------- | --------:|
| 2.0 | 1.0 | 1.5 |

### Run12: camembert-finetuné-less-naive-weighted
	Camembert finetuné pendant 1200 steps avec modification des poids avec un poids plus élevé pour la classe Entrée
 	La modification des poids se fait directement dans le fichier legal_eval_ft.py ligne 47 
 	Utilisation : 
  		fine-tuning : 
			python3 legal_eval_ft.py --data-path ./data/distilbert/recette \
						 --model-name almanach/camembert-base \
						 --output-dir ./models/camembert-base-naive-weights-/ \
						 --custom-trainer \
						 --num-epochs 10 
		inférence : 
  			python3 legal_eval_infer.py ./data/distilbert/recette/test.csv \
						--model-name ./models/camembert-base-less-naive-weights-/almanach_camembert-base-ft-BUILD/checkpoint-1200   
| Entrée      | Plat principal | Dessert |
| -------- | -------- | --------:|
| 3.0 | 1.0 | 1.5 |

### Liens huggingface pour git clone les modèles dans le dossier ./models
[camembert-base](https://huggingface.co/labicquette/camembert-base)
 	
[distilbertcheffo](https://huggingface.co/labicquette/distilbertcheffo)

[camembert-base-combination](https://huggingface.co/labicquette/camembert-base-combination)

[camembert-base-naive-weights](https://huggingface.co/labicquette/camembert-base-naive-weights)

[camembert-base-less-naive-weights](https://huggingface.co/labicquette/camembert-base-less-naive-weights)

## Résumé Résultats

| Run      | f1 Score |
| -------- | --------:|
| baseline |  21,1 |
| Word2Vec+MLP  |  80,0|
| TFIDF-RF+SMOTE+norm |  85,0 |
| TFIDF-RF+SMOTE |  84,0 |
| distilbert-ft-recette-3120   | 85,7  |
| camembert-base-1248   | 87,6 |	
| camembert-base-less-naive-weights-1200   | 87,9 |	

### Analyse des résultats

#### Architectures TF-IDF :
Premièrement, nous avons étudié la distribution des types de recettes à travers notre dataset. Nous avons remarqué que les plats principaux étaient une classe majoritaire. Ensuite, nous avons testé une pipeline avec TF-IDF et la méthode RandomForestClassifier. Cela a donné un score F1 en général de 77,0. Nous avons remarqué que le classifieur avait du mal à séparer les entrées et les plats principaux car les recettes se ressemblent et comme les plats principaux sont une classe majoritaire, le classifieur a tendance à donner une réponse biaisée.

Deuxièmement, nous avons testé un autre classifieur, le KNN (K-Nearest Neighbors), celui-ci s'est montré plus performant avec un score F1 de 78,0. Le classifieur arrivait à mieux séparer les plats principaux et les entrées.

Troisièmement, nous avons décidé de normaliser les données en enlevant toutes les majuscules et les "mots vides" ainsi que la ponctuation dans les recettes afin de les simplifier. Nous avons également décidé d'utiliser une technique nommée SMOTE (Synthetic Minority Over-sampling Technique) pour générer des exemples synthétiques pour les classes minoritaires en interpolant entre les instances existantes. Pour le RandomForest, les résultats ont augmenté (jusqu'à 81), mais ont baissé pour le KNN (jusqu'à 50). Ceci peut être dû au fait que le KNN est un algorithme qui fonctionne quand une grande classe majoritaire est présente dans une donnée, mais comme cette classe majoritaire a été supprimée grâce au SMOTE, le KNN fonctionne mal.

#### Architectures BERT :
Pour commencer nous avons étudié l'impact des classes sur l'entraînement de distilbert, recette est l'unique classe permettant d'atteindre des scores supérieurs à 85, en effet, titre, ingrédients ainsi que la combinaison des 3 ont de moins bonnes performances. 

Nous nous sommes donc tournés vers l'utilisation d'un modèle de langue entraîné sur la langue française, le tokenizer de distilbert retirant les accents. 
Nous observons les meilleurs résultats grâce à camembert entraîné sur les recettes. 

Pour améliorer ces résultats nous nous sommes penchés comme précédemment vers la modification de la représentation des classes. Ici nous modifions les poids de la loss function en augmentant l'importance de la classe Entrée et Dessert en suivant leurs répartition dans la classe Train. La courbe d'apprentissage est plus lisse et nous obtenons un score de 87,9. L'entrée reste tout de même la classe tirant vers les bas les performances.

#### Pistes d'amélioration :
- Modifier la tâche de classification de phrases en tâche de masquage de token en masquant le dernier token qui serait dans notre cas un des trois labels de classe. En faisant ainsi il serait alors possible d'utiliser des méthodes d'optimisation de prompt telles que le few-shot learning qui généralement améliore les performances.
- Idée venant de Rémi ILANGO, utiliser une architecture Mixture of Experts (MoE) où chaque expert serait spécialisé dans une des trois classes. Il a par contre été vu que la spécialisation des experts n'a pas d'impact sur la séléction de ceux-ci durant l'inférence. L'idée reste tout de même intéressante.
- Utiliser les ingrédients en nettoyant les données pour n'avoir que les ingrédients sans les quantités et les mots de liaison pouvant ajouter du bruit autour de l'information importante.
- Essayer de traiter durant l'entraînement des batchs contenant uniquement une recette pour ne pas bruiter l'apprentissage.

## Résultats Préliminaires:
| Run      | f1 Score |
| -------- | --------:|
| baseline |  21,1 |
| Word2Vec+MLP  |  80,0|

## Résultats TF-IDF:

| Run      | f1 Score |
| -------- | --------:|
| TFIDF-RF |  77,0 |
| TFIDF-KNN |  78,0 |
| TFIDF-RF+SMOTE |  83,0 |
| TFIDF-KNN+SMOTE |  50,0 |

## Résultats TF-IDF normalisés:

| Run      | f1 Score |
| -------- | --------:|
| TFIDF-RF |  76,0 |
| TFIDF-KNN |  78,0 |
| TFIDF-RF+SMOTE |  81,0 |
| TFIDF-KNN+SMOTE |  50,0 |

## Résultats Transformers BERT:

| Run      | f1 Score |
| -------- | --------:|
| distilbert-ft-recette-3120   | 85,7  |
| distilbert-ft-ingredients-3744   | 83,0  |	
| camembert-base-1248   | 87,6 |	
| camembert-base-naive-weights-1900   | 87,6 |	
| camembert-base-less-naive-weights-1200   | 87,9 |	
